source("err.R")#
source("lamfix.R")#
source("zeromat.R")#
source("nonzero.R")#
source("mls.R")#
library(Matrix)#
dyn.load("mls.so")#
#
#
dl <- function(r)#
{#
	d=2*r#
	d#
}#
#
x=matrix(rnorm(7*15),7,15)#
y=matrix(rnorm(7*3),7,3)#
#
n=nrow(x)#
p=ncol(x)#
ng=ncol(y)#
#
#
#
pf=rep(1,p)#
m1 <-mls(y=y,x=x,eps=1e-12,x.normalize=F,y.normalize=F,pf=pf)#
pf=pf*p/sum(pf)
B=m1$beta
ri <- y-(x%*%B[[1]]+matrix(1,7,1)%*%m1$b0[,1])
y
ri <- y-(x%*%B[[4]]+matrix(1,7,1)%*%m1$b0[,4])
ri
dl <- function(r)#
{#
	d=2*r#
	d#
}
	L = dl(ri)
L
crossprod(x[,j],L)
crossprod(x[,1],L)
yxlnorm <- sqrt(crossprod(yxl,yxl))
yxl <- crossprod(x[,g],L)
yxl <- crossprod(x[,1],L)
setwd('/Users/yiyang/europa/mls')
		yxlnorm <- sqrt(crossprod(yxl,yxl))
		Bnorm<-sqrt(crossprod(B[[1]][1,],B[[1]][1,]))
		Bnorm<-sqrt(crossprod(B[[3]][1,],B[[3]][1,]))
		Bnorm<-sqrt(crossprod(B[[30]][1,],B[[30]][1,]))
Bnorm
B[[1]]
B[[30]]
setwd('/Users/yiyang/Documents/Research/bmd/virgo/bmdls')
source("bmd.ls.r")#
source("err.r")#
source("lamfix.r")#
source("plot.bmd.r")#
source("plot.bmd.ls.r")#
dyn.load("bmdls.so")#
#
dl <- function(r)#
{#
	d=rep(0,length(r))#
	for (i in 1:length(r))#
	{#
		d[i]=2*r[i]#
	}#
	return (d)#
}#
#
#
set.seed(11)#
x=matrix(rnorm(10*200),10,200) #
set.seed(11)#
y=sample(c(-1,1),10,replace=T)#
group<-rep(1:200,each=1)#
nobs=nrow(x)#
nvars=ncol(x)#
#m0 <-bmd.ls(y=y,x=x,group=group,eps=1e-6)#
#
bn=as.integer(max(group))#
bs=as.integer(as.numeric(table(group)))#
pf=rep(1,bn)#
m1 <-bmd.ls(y=y,x=x,group=group,eps=1e-13,standardize=F,pf=pf)#
#
#
one=rep(1, nobs)#
meanx=drop(one %*% x)/nobs#
x=scale(x, meanx, FALSE)#
#
# ix=rep(0,bn)#
# iy=rep(0,bn)#
# j=1#
# for(g in 1:bn)#
# {#
# 	ix[g]=j#
# 	iy[g]=j+bs[g]-1#
# 	j=j+bs[g]#
# }#
# ix=as.integer(ix)#
# iy=as.integer(iy)#
# for (g in 1:bn)#
# {#
# 	ind=ix[g]:iy[g]#
# 	decomp <- qr(x[,ind])#
# 	if(decomp$rank < bs[g]) stop("Block belonging to columns ",  ## Warn if block has not full rank#
# 	paste(ind, collapse = ", ")," has not full rank! \n")#
# 	x[,ind] <- qr.Q(decomp)#
# }#
#
pf=pf*bn/sum(pf) #
B <- as.matrix(m1$beta)#
MM <- matrix(0,bn,length(m1$lambda))#
for (l in 1:length(m1$lambda))#
{#
	for (g in 1:bn)#
	{	#
		ind=(group==g)#
		ri <- y-(x%*%B[,l]+m1$b0[l])#
 		L = dl(ri)#
		yxl <- t(x[,ind])%*%L#
		yxlnorm <- sqrt(crossprod(yxl,yxl))#
		Bnorm<-sqrt(crossprod(B[ind,l],B[ind,l]))#
		#
		if(Bnorm!=0)#
		{#
			AA<- -yxl+  B[ind,l]*m1$lambda[l]*pf[g]*sqrt(bs[g])/Bnorm#
			if(abs(sum(AA))<1e-10) MM[g,l] <- "."#
			else{#
				MM[g,l] <- "F"#
				print(AA)#
			} #
			#
		}#
		else#
		{#
			BB <- yxlnorm - pf[g] * m1$lambda[l] * sqrt(bs[g])#
			if (BB<=0) MM[g,l] <- "."#
			else {#
					MM[g,l] <- "f"#
					print(paste("this is",BB))#
				}#
		}#
	}#
}#
print(MM)
